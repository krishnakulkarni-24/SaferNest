<div class="page">
  <h2 class="alerts-heading">Active Alerts</h2>

  <div class="card controls">
    <div class="controls-row">
      <div class="control">
        <label for="filter-type">Type</label>
        <select id="filter-type" aria-label="Filter by type" [(ngModel)]="type" (ngModelChange)="applyFilter()">
          <option value="">All</option>
          <option value="flood">Flood</option>
          <option value="earthquake">Earthquake</option>
          <option value="fire">Fire</option>
          <option value="storm">Storm</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="control">
        <label for="filter-severity">Severity</label>
        <select id="filter-severity" aria-label="Filter by severity" [(ngModel)]="severity" (ngModelChange)="applyFilter()">
          <option value="">All</option>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
          <option value="critical">Critical</option>
        </select>
      </div>
    </div>
  </div>

  <div *ngIf="filtered.length === 0" class="card no-matches">No matching alerts. Stay safe!</div>
    <div *ngFor="let alert of filtered; trackBy: trackById" class="card alert-card">
    <div class="alert-header">
  <strong class="alert-title">{{ alert.title }}</strong>
  <span *ngIf="alert.active === false" class="muted deactivated-badge">(Deactivated)</span>
      <span class="muted">Severity: {{ alert.severity }} | Type: {{ alert.type }} <span *ngIf="alert.task?.title">| Task: {{ alert.task.title }}</span> <span *ngIf="alert.volunteersAccepted?.length">| Accepted: {{ alert.volunteersAccepted.length }}</span></span>
    </div>
    <p class="alert-message">{{ alert.message }}</p>

    <!-- Volunteer actions -->
  <div *ngIf="auth.getUser()?.role === 'volunteer' && alert.active" class="volunteer-actions">
      <ng-container *ngIf="alert.task?.title || alert.task?.description; else noTask">
        <button *ngIf="!isVolunteerAccepted(alert)" (click)="acceptTask(alert)">Accept Task</button>
        <button *ngIf="isVolunteerAccepted(alert)" disabled>Accepted âœ“</button>
      </ng-container>
      <ng-template #noTask>
        <span class="muted">No task assigned for this alert.</span>
      </ng-template>
    </div>

    <!-- Resident actions: Need Help -->
    <div *ngIf="auth.getUser()?.role === 'resident' && alert.active" class="resident-actions">
      <div *ngIf="needHelpAlertId !== alert._id">
        <button (click)="openHelp(alert)">Need Help</button>
      </div>
      <div *ngIf="needHelpAlertId === alert._id" class="help-form">
        <label for="help-address">Your Address</label>
        <input id="help-address" [(ngModel)]="help.address" placeholder="Enter address or location" aria-label="Help request address" />
        <div class="help-form-actions">
          <button (click)="submitHelp(alert)" [disabled]="!help.address">Submit Request</button>
          <button type="button" (click)="cancelHelp()">Cancel</button>
        </div>
        <div *ngIf="helpError" class="form-error">{{ helpError }}</div>
      </div>
    </div>

    <!-- Admin actions: Edit / Delete -->
    <div *ngIf="auth.getUser()?.role === 'admin'" class="admin-actions">
      <button type="button" *ngIf="editingId !== alert._id" (click)="confirmDelete(alert)" class="danger">Delete</button>
      <button type="button" *ngIf="editingId !== alert._id" (click)="beginEdit(alert)">Edit</button>
    </div>
    <div *ngIf="editingId === alert._id" class="edit-form">
      <label>Title</label>
      <input [(ngModel)]="editModel.title" placeholder="Title" aria-label="Edit alert title" />
      <label>Message</label>
      <textarea [(ngModel)]="editModel.message" placeholder="Message" aria-label="Edit alert message"></textarea>
      <label>Type</label>
      <select [(ngModel)]="editModel.type" aria-label="Edit alert type">
        <option value="flood">Flood</option>
        <option value="earthquake">Earthquake</option>
        <option value="fire">Fire</option>
        <option value="storm">Storm</option>
        <option value="other">Other</option>
      </select>
      <label>Severity</label>
      <select [(ngModel)]="editModel.severity" aria-label="Edit alert severity">
        <option value="low">Low</option>
        <option value="medium">Medium</option>
        <option value="high">High</option>
        <option value="critical">Critical</option>
      </select>
      <label>Task Title (optional)</label>
      <input [(ngModel)]="editModel.task.title" placeholder="Task title" aria-label="Task title" />
      <label>Task Description (optional)</label>
      <textarea [(ngModel)]="editModel.task.description" placeholder="Task description" aria-label="Task description"></textarea>
      <div class="edit-actions">
        <button (click)="saveEdit(alert)">Save</button>
        <button type="button" (click)="cancelEdit()">Cancel</button>
      </div>
      <div *ngIf="saveError" class="form-error">{{ saveError }}</div>
    </div>
  </div>
</div>